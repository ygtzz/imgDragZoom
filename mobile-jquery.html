<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mobile jquery</title>
    <style>
      th {
        resize: horizontal;
        overflow: auto;
      }
      .con {
        background-color: #bababa;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }
      .outerdiv{
        position: fixed;
        top: 0;
        left: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 2;
        width: 100%;
        height: 100%;
        display: none;
      }
      .img {border: 5px solid #fff;display:block;}
    </style>
  </head>

  <body class="con">
    <img width="200" height="100" src="/imgs/aa.jpg" alt="aaa" />
    <div id="outerdiv" class="outerdiv">
      <div id="innerdiv" style="position: absolute">
        <img id="bigimg" class="img" src="" />
      </div>
    </div>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/1.9.0/jquery.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/vConsole/3.15.1/vconsole.min.js"></script>
    <script>
      var vConsole = new window.VConsole();

      $(function () {
        var outerdiv = document.getElementById('outerdiv');
        var innerdiv = document.getElementById('innerdiv');

        $("img").click(function () {
          var _this = $(this); //Â∞ÜÂΩìÂâçÁöÑpimgÂÖÉÁ¥†‰Ωú‰∏∫_this‰º†ÂÖ•ÂáΩÊï∞
          imgShow("#outerdiv", "#innerdiv", "#bigimg", _this);
          //ÁßªÂä®Á´ØÊâãÊåáÁßªÂä®‰∫ã‰ª∂,Â¶ÇÊûú‰∏çÈúÄË¶ÅÁßªÂä®Á´ØÊâãÊåá‰∫ã‰ª∂,Ëøô‰∏ÄÈÉ®ÂàÜÂÜÖÂÆπÂèØ‰ª•‰∏çÂä†,Âè™Ë¶Å‰∏äÈù¢‰∏§Ë°å‰ª£Á†Å‰ª•ÂèäimgShow()‰∫ã‰ª∂
          var eleImg = document.querySelector("#innerdiv");
          var store = {
            scale: 1,
          };
          //ÂÆö‰πâÁßªÂä®Á´ØÁöÑÂàùÂßã‰ΩçÁΩÆ
          var position_top, position_left, pageX, pageY;
          // Áº©Êîæ‰∫ã‰ª∂ÁöÑÂ§ÑÁêÜ
          //‰∫ã‰ª∂ÂºÄÂßã
          eleImg.addEventListener(
            "touchstart",
            function (event) {
              event.preventDefault(); //ÈòªÊ≠¢ÈªòËÆ§‰∫ã‰ª∂ÔºåÈò≤Ê≠¢Â∫ïÈÉ®ÂÜÖÂÆπÊªöÂä®
              //Âú®Ëß¶Â±èËÆæÂ§á‰∏ãÔºåË¶ÅÂà§Êñ≠ÊòØÂçïÊåáËøòÊòØÂ§öÊåáÊìç‰ΩúÔºåÂèØ‰ª•ÈÄöËøáevent.touchesÊï∞ÁªÑÂØπË±°ÁöÑÈïøÂ∫¶Âà§Êñ≠„ÄÇ
              var touches = event.touches;
              var events = touches[0]; //ÂçïÊåá
              var events2 = touches[1]; //ÂèåÊåá
              if (touches.length == 1) {
                //ÂçïÊåáÊìç‰Ωú
                pageX = Number(events.pageX);
                pageY = Number(events.pageY);
                store.moveable = true;
                var _obj = $("#innerdiv");
                //  .cssËé∑ÂèñÁöÑÂÄºÊòØÂ≠óÁ¨¶‰∏≤
                position_left = parseFloat(_obj.css("left").split("px"));
                position_top = parseFloat(_obj.css("top").split("px"));
              } else {
                // Á¨¨‰∏Ä‰∏™Ëß¶Êë∏ÁÇπÁöÑÂùêÊ†á
                store.pageX = events.pageX;
                store.pageY = events.pageY;
                store.moveable = true;
                if (events2) {
                  store.pageX2 = events2.pageX;
                  store.pageY2 = events2.pageY;
                }
                store.originScale = store.scale || 1;
              }
            },
            { passive: false }
          ); //passive: falseÂøÖÈ°ªÂä†‰∏ä,Âê¶ÂàôÊéßÂà∂Âè∞Êä•Èîô
          
          //ÂºÄÂßãÁßªÂä®
          document.addEventListener(
            "touchmove",
            function (event) {
              event.preventDefault(); //ÈòªÊ≠¢ÈªòËÆ§‰∫ã‰ª∂ÔºåÈò≤Ê≠¢Â∫ïÈÉ®ÊªöÂä®
              if (!store.moveable) {
                return;
              }
              var touches = event.touches;
              var events = touches[0];
              var events2 = touches[1];
              if (touches.length == 1) {
                var pageX2 = Number(events.pageX);
                var pageY2 = Number(events.pageY);
                let top = position_top + pageY2 - pageY;
                let left = position_left + pageX2 - pageX;
                let scale = innerdiv.style.transform;
                console.log("üöÄ ~ file: index.html:111 ~ scale:", scale)
                if(scale){
                  let scaleReg = /scale\((.+)\)/;
                  console.log("üöÄ ~ file: index.html:114 ~ scaleReg:", scaleReg)
                  let match = scale.match(scaleReg);
                  console.log("üöÄ ~ file: index.html:116 ~ match:", match)
                  if(match && match[1]){
                    scale = parseFloat(match[1]);
                    console.log("üöÄ ~ file: index.html:119 ~ scale:", scale)
                  }
                }
                if(!scale){
                  scale = 1;
                  console.log("üöÄ ~ file: index.html:124 ~ scale:", scale)
                }
                
                let {offsetWidth:outerWidth,offsetHeight:outerHeight} = outerdiv;
                let {offsetWidth:innerWidth,offsetHeight:innerHeight} = innerdiv;
                let inlineMin,inlineMax;
                let blockMin,blockMax;
                let innerInlineR =  innerWidth/2;
                let scaleInline = (innerInlineR * scale - innerInlineR);
                let innerBlockR = innerHeight/2;
                let scaleBlock = (innerBlockR * scale - innerBlockR);
                let leeway = 10;
                // ÂõæÁâáÊ®™ÂêëÂ§ß‰∫éÊ°ÜÂ≠ê
                console.log('1: ', outerWidth - innerWidth * scale, scale > 1)
                if(outerWidth - innerWidth * scale < 0){
                  inlineMin = outerWidth - innerWidth - scaleInline;
                  console.log("üöÄ ~ file: index.html:131 ~ inlineMin:", inlineMin)
                  inlineMax = scaleInline;
                  console.log("üöÄ ~ file: index.html:133 ~ inlineMax:", inlineMax)
                }
                else if(scale > 1){
                  inlineMin = scaleInline;
                  inlineMax = outerWidth - innerWidth - scaleInline;
                }
                else{
                  inlineMin = 0;
                  inlineMax = outerWidth - innerWidth;
                }
                // ÂõæÁâáÁ∫µÂêëÂ§ß‰∫éÊ°ÜÂ≠ê
                if(outerHeight - innerHeight * scale < 0){
                  blockMin = outerHeight - innerHeight - scaleBlock;
                  blockMax = scaleBlock;
                }
                else if(scale > 1){
                  // blockMin = scaleBlock;
                  // blockMax = outerHeight - innerHeight - scaleBlock;
                  // ÂõæÁâá‰∏ä‰∏ãÂèØ‰ª•Âá∫Âéª‰∏ÄÁÇπÔºåÊñπ‰æøÁúãÊ∏ÖÂØπ‰æßÈÉ®ÂàÜ
                  blockMin = 0;
                  blockMax = outerHeight - innerHeight;
                }
                else{
                  blockMin = 0;
                  blockMax = outerHeight - innerHeight;
                }
                left = Math.max(inlineMin - leeway, Math.min(left, inlineMax + leeway));
                top = Math.max(blockMin - leeway, Math.min(top, blockMax + leeway));
               
                //ÊéßÂà∂ÂõæÁâáÁßªÂä®
                $("#innerdiv").css({
                  top: top + "px",
                  left: left + "px",
                });
              } else {
                // ÂèåÊåáÁßªÂä®
                if (events2) {
                  // Á¨¨2‰∏™ÊåáÂ§¥ÂùêÊ†áÂú®touchmoveÊó∂ÂÄôËé∑Âèñ
                  if (!store.pageX2) {
                    store.pageX2 = events2.pageX;
                  }
                  if (!store.pageY2) {
                    store.pageY2 = events2.pageY;
                  }

                  // Ëé∑ÂèñÂùêÊ†á‰πãÈó¥ÁöÑË∑ùÁ¶ª
                  var getDistance = function (start, stop) {
                    //Áî®Âà∞‰∏âËßíÂáΩÊï∞
                    return Math.hypot(stop.x - start.x, stop.y - start.y);
                  };
                  // ÂèåÊåáÁº©ÊîæÊØî‰æãËÆ°ÁÆó
                  var zoom =
                    getDistance(
                      {
                        x: events.pageX,
                        y: events.pageY,
                      },
                      {
                        x: events2.pageX,
                        y: events2.pageY,
                      }
                    ) /
                    getDistance(
                      {
                        x: store.pageX,
                        y: store.pageY,
                      },
                      {
                        x: store.pageX2,
                        y: store.pageY2,
                      }
                    );
                  // Â∫îÁî®Âú®ÂÖÉÁ¥†‰∏äÁöÑÁº©ÊîæÊØî‰æã
                  var newScale = store.originScale * zoom * 0.8;
                  var maxScale = 3, minScale = 1;
                  // ÊúÄÂ§ßÁº©ÊîæÊØî‰æãÈôêÂà∂
                  if (newScale > maxScale) {
                    newScale = maxScale;
                  }
                  if(newScale < minScale){
                    newScale = minScale;
                  }
                  // ËÆ∞‰Ωè‰ΩøÁî®ÁöÑÁº©ÊîæÂÄº
                  store.scale = newScale;
                  // ÂõæÂÉèÂ∫îÁî®Áº©ÊîæÊïàÊûú
                  eleImg.style.transform = "scale(" + newScale + ")";
                }
              }
            },
            { passive: false }
          );

          document.addEventListener("touchend", function () {
            store.moveable = false;
            delete store.pageX2;
            delete store.pageY2;
          });
          document.addEventListener("touchcancel", function () {
            store.moveable = false;
            delete store.pageX2;
            delete store.pageY2;
          });
        });
        //ÁßªÂä®Á´ØÊâãÊåáÈ°µÈù¢ÁªìÊùü
      });

      //ÈÅÆÁΩ©Â±ÇÂõæÁâá‰ΩçÁΩÆ
      function imgShow(outerdiv, innerdiv, bigimg, _this) {
        //ËøôÊòØÂàöÊâçÂà§Êñ≠ÊòØÂê¶PCÁ´ØÁöÑÂáΩÊï∞‰∫ã‰ª∂
        var flag = IsPC();
        console.log(flag);
        var src = _this.attr("src"); //Ëé∑ÂèñÂΩìÂâçÁÇπÂáªÁöÑpimgÂÖÉÁ¥†‰∏≠ÁöÑsrcÂ±ûÊÄß
        $(bigimg).attr("src", src); //ËÆæÁΩÆ#bigimgÂÖÉÁ¥†ÁöÑsrcÂ±ûÊÄß
        /*Ëé∑ÂèñÂΩìÂâçÁÇπÂáªÂõæÁâáÁöÑÁúüÂÆûÂ§ßÂ∞èÔºåÂπ∂ÊòæÁ§∫ÂºπÂá∫Â±ÇÂèäÂ§ßÂõæ*/
        $("<img/>")
          .attr("src", src)
          .load(function () {
            //Ê≥®ÊÑèÂú®‰ΩøÁî®ËøôÁßçÊñπÊ≥ïËé∑ÂèñÁ™óÂè£È´òÂ∫¶ÂíåÂÆΩÂ∫¶ÁöÑÊó∂ÂÄô,
            //Âä°ÂøÖÂú®htmlÈ°µÈù¢ÊúÄ‰∏äÊñπÂä†‰∏ä‰∏ÄÂè•<!DOCTYPE html>,Âê¶ÂàôËé∑ÂèñÂ±èÂπïÈ´òÂ∫¶Êó∂‰ºöÂá∫ÈóÆÈ¢ò
            var windowW = $(window).width(); //Ëé∑ÂèñÂΩìÂâçÁ™óÂè£ÂÆΩÂ∫¶
            console.log("üöÄ ~ file: index copy.html:262 ~ windowW:", windowW)
            var windowH = $(window).height(); //Ëé∑ÂèñÂΩìÂâçÁ™óÂè£È´òÂ∫¶
            console.log("üöÄ ~ file: index copy.html:264 ~ windowH:", windowH)
            var realWidth = this.width; //Ëé∑ÂèñÂõæÁâáÁúüÂÆûÂÆΩÂ∫¶
            var realHeight = this.height; //Ëé∑ÂèñÂõæÁâáÁúüÂÆûÈ´òÂ∫¶
            var imgWidth, imgHeight;
            var scale = 0.8; //Áº©ÊîæÂ∞∫ÂØ∏ÔºåÂΩìÂõæÁâáÁúüÂÆûÂÆΩÂ∫¶ÂíåÈ´òÂ∫¶Â§ß‰∫éÁ™óÂè£ÂÆΩÂ∫¶ÂíåÈ´òÂ∫¶Êó∂ËøõË°åÁº©Êîæ
            if (realHeight > windowH * scale) {
              //Âà§Êñ≠ÂõæÁâáÈ´òÂ∫¶
              imgHeight = windowH * scale; //Â¶ÇÂ§ß‰∫éÁ™óÂè£È´òÂ∫¶ÔºåÂõæÁâáÈ´òÂ∫¶ËøõË°åÁº©Êîæ
              imgWidth = (imgHeight / realHeight) * realWidth; //Á≠âÊØî‰æãÁº©ÊîæÂÆΩÂ∫¶
              if (imgWidth > windowW * scale) {
                //Â¶ÇÂÆΩÂ∫¶ÊâîÂ§ß‰∫éÁ™óÂè£ÂÆΩÂ∫¶
                imgWidth = windowW * scale; //ÂÜçÂØπÂÆΩÂ∫¶ËøõË°åÁº©Êîæ
              }
            } else if (realWidth > windowW * scale) {
              //Â¶ÇÂõæÁâáÈ´òÂ∫¶ÂêàÈÄÇÔºåÂà§Êñ≠ÂõæÁâáÂÆΩÂ∫¶
              imgWidth = windowW * scale; //Â¶ÇÂ§ß‰∫éÁ™óÂè£ÂÆΩÂ∫¶ÔºåÂõæÁâáÂÆΩÂ∫¶ËøõË°åÁº©Êîæ
              imgHeight = (imgWidth / realWidth) * realHeight; //Á≠âÊØî‰æãÁº©ÊîæÈ´òÂ∫¶
            } else {
              //Â¶ÇÊûúÂõæÁâáÁúüÂÆûÈ´òÂ∫¶ÂíåÂÆΩÂ∫¶ÈÉΩÁ¨¶ÂêàË¶ÅÊ±ÇÔºåÈ´òÂÆΩ‰∏çÂèò
              if (flag == false) {
                imgWidth = realWidth;
                imgHeight = realHeight;
              } else if (realWidth >= 1000) {
                //ËøôÈáåÊàëÊÄïÂõæÁâáÂ§™Â§ßÂèàÂÅö‰∫Ü‰∏™Âà§Êñ≠
                imgWidth = realWidth;
                imgHeight = realHeight;
              } else {
                imgWidth = realWidth * 2;
                imgHeight = realHeight * 2;
              }
            }
            $(bigimg).css("width", imgWidth); //‰ª•ÊúÄÁªàÁöÑÂÆΩÂ∫¶ÂØπÂõæÁâáÁº©Êîæ
            var w = (windowW - imgWidth) / 2; //ËÆ°ÁÆóÂõæÁâá‰∏éÁ™óÂè£Â∑¶ËæπË∑ù
            var h = (windowH - imgHeight) / 2; //ËÆ°ÁÆóÂõæÁâá‰∏éÁ™óÂè£‰∏äËæπË∑ù
            $(innerdiv).css({
              top: h,
              left: w,
            }); //ËÆæÁΩÆ#innerdivÁöÑtopÂíåleftÂ±ûÊÄß
            $(outerdiv).fadeIn("fast"); //Ê∑°ÂÖ•ÊòæÁ§∫#outerdivÂèä.pimg
          });
        $(outerdiv).click(function () {
          //ÂÜçÊ¨°ÁÇπÂáªÊ∑°Âá∫Ê∂àÂ§±ÂºπÂá∫Â±Ç
          $(this).fadeOut("fast");
        });
      }

      function IsPC(){  
        var userAgentInfo = navigator.userAgent;
        var Agents = new Array("Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod");  
        var flag = true;  
        for (var v = 0; v < Agents.length; v++) {  
            if (userAgentInfo.indexOf(Agents[v]) > 0) { flag = false; break; }  
        }  
        return flag;  
      }
    </script>
  </body>
</html>
