<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mobile jquery</title>
    <style>
      th {
        resize: horizontal;
        overflow: auto;
      }
      .con {
        background-color: #bababa;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }
      .outerdiv{
        position: fixed;
        top: 0;
        left: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 2;
        width: 100%;
        height: 100%;
        display: none;
      }
      .img {border: 5px solid #fff;display:block;}
    </style>
  </head>

  <body class="con">
    <img width="200" height="100" src="/imgs/aa.jpg" alt="aaa" />
    <div id="outerdiv" class="outerdiv">
      <div id="innerdiv" style="position: absolute">
        <img id="bigimg" class="img" src="" />
      </div>
    </div>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/1.9.0/jquery.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/vConsole/3.15.1/vconsole.min.js"></script>
    <script>
      var vConsole = new window.VConsole();

      $(function () {
        var outerdiv = document.getElementById('outerdiv');
        var innerdiv = document.getElementById('innerdiv');

        $("img").click(function () {
          var _this = $(this); //å°†å½“å‰çš„pimgå…ƒç´ ä½œä¸º_thisä¼ å…¥å‡½æ•°
          imgShow("#outerdiv", "#innerdiv", "#bigimg", _this);
          //ç§»åŠ¨ç«¯æ‰‹æŒ‡ç§»åŠ¨äº‹ä»¶,å¦‚æœä¸éœ€è¦ç§»åŠ¨ç«¯æ‰‹æŒ‡äº‹ä»¶,è¿™ä¸€éƒ¨åˆ†å†…å®¹å¯ä»¥ä¸åŠ ,åªè¦ä¸Šé¢ä¸¤è¡Œä»£ç ä»¥åŠimgShow()äº‹ä»¶
          var eleImg = document.querySelector("#innerdiv");
          var store = {
            scale: 1,
          };
          //å®šä¹‰ç§»åŠ¨ç«¯çš„åˆå§‹ä½ç½®
          var position_top, position_left, pageX, pageY;
          // ç¼©æ”¾äº‹ä»¶çš„å¤„ç†
          //äº‹ä»¶å¼€å§‹
          eleImg.addEventListener(
            "touchstart",
            function (event) {
              event.preventDefault(); //é˜»æ­¢é»˜è®¤äº‹ä»¶ï¼Œé˜²æ­¢åº•éƒ¨å†…å®¹æ»šåŠ¨
              //åœ¨è§¦å±è®¾å¤‡ä¸‹ï¼Œè¦åˆ¤æ–­æ˜¯å•æŒ‡è¿˜æ˜¯å¤šæŒ‡æ“ä½œï¼Œå¯ä»¥é€šè¿‡event.touchesæ•°ç»„å¯¹è±¡çš„é•¿åº¦åˆ¤æ–­ã€‚
              var touches = event.touches;
              var events = touches[0]; //å•æŒ‡
              var events2 = touches[1]; //åŒæŒ‡
              if (touches.length == 1) {
                //å•æŒ‡æ“ä½œ
                pageX = Number(events.pageX);
                pageY = Number(events.pageY);
                store.moveable = true;
                var _obj = $("#innerdiv");
                //  .cssè·å–çš„å€¼æ˜¯å­—ç¬¦ä¸²
                position_left = parseFloat(_obj.css("left").split("px"));
                position_top = parseFloat(_obj.css("top").split("px"));
              } else {
                // ç¬¬ä¸€ä¸ªè§¦æ‘¸ç‚¹çš„åæ ‡
                store.pageX = events.pageX;
                store.pageY = events.pageY;
                store.moveable = true;
                if (events2) {
                  store.pageX2 = events2.pageX;
                  store.pageY2 = events2.pageY;
                }
                store.originScale = store.scale || 1;
              }
            },
            { passive: false }
          ); //passive: falseå¿…é¡»åŠ ä¸Š,å¦åˆ™æ§åˆ¶å°æŠ¥é”™
          
          //å¼€å§‹ç§»åŠ¨
          document.addEventListener(
            "touchmove",
            function (event) {
              event.preventDefault(); //é˜»æ­¢é»˜è®¤äº‹ä»¶ï¼Œé˜²æ­¢åº•éƒ¨æ»šåŠ¨
              if (!store.moveable) {
                return;
              }
              var touches = event.touches;
              var events = touches[0];
              var events2 = touches[1];
              if (touches.length == 1) {
                var pageX2 = Number(events.pageX);
                var pageY2 = Number(events.pageY);
                let top = position_top + pageY2 - pageY;
                let left = position_left + pageX2 - pageX;
                let scale = innerdiv.style.transform;
                console.log("ğŸš€ ~ file: index.html:111 ~ scale:", scale)
                if(scale){
                  let scaleReg = /scale\((.+)\)/;
                  console.log("ğŸš€ ~ file: index.html:114 ~ scaleReg:", scaleReg)
                  let match = scale.match(scaleReg);
                  console.log("ğŸš€ ~ file: index.html:116 ~ match:", match)
                  if(match && match[1]){
                    scale = parseFloat(match[1]);
                    console.log("ğŸš€ ~ file: index.html:119 ~ scale:", scale)
                  }
                }
                if(!scale){
                  scale = 1;
                  console.log("ğŸš€ ~ file: index.html:124 ~ scale:", scale)
                }
                
                let {offsetWidth:outerWidth,offsetHeight:outerHeight} = outerdiv;
                let {offsetWidth:innerWidth,offsetHeight:innerHeight} = innerdiv;
                let inlineMin,inlineMax;
                let blockMin,blockMax;
                let innerInlineR =  innerWidth/2;
                let scaleInline = (innerInlineR * scale - innerInlineR);
                let innerBlockR = innerHeight/2;
                let scaleBlock = (innerBlockR * scale - innerBlockR);
                let leeway = 10;
                // å›¾ç‰‡æ¨ªå‘å¤§äºæ¡†å­
                console.log('1: ', outerWidth - innerWidth * scale, scale > 1)
                if(outerWidth - innerWidth * scale < 0){
                  inlineMin = outerWidth - innerWidth - scaleInline;
                  console.log("ğŸš€ ~ file: index.html:131 ~ inlineMin:", inlineMin)
                  inlineMax = scaleInline;
                  console.log("ğŸš€ ~ file: index.html:133 ~ inlineMax:", inlineMax)
                }
                else if(scale > 1){
                  inlineMin = scaleInline;
                  inlineMax = outerWidth - innerWidth - scaleInline;
                }
                else{
                  inlineMin = 0;
                  inlineMax = outerWidth - innerWidth;
                }
                // å›¾ç‰‡çºµå‘å¤§äºæ¡†å­
                if(outerHeight - innerHeight * scale < 0){
                  blockMin = outerHeight - innerHeight - scaleBlock;
                  blockMax = scaleBlock;
                }
                else if(scale > 1){
                  // blockMin = scaleBlock;
                  // blockMax = outerHeight - innerHeight - scaleBlock;
                  // å›¾ç‰‡ä¸Šä¸‹å¯ä»¥å‡ºå»ä¸€ç‚¹ï¼Œæ–¹ä¾¿çœ‹æ¸…å¯¹ä¾§éƒ¨åˆ†
                  blockMin = 0;
                  blockMax = outerHeight - innerHeight;
                }
                else{
                  blockMin = 0;
                  blockMax = outerHeight - innerHeight;
                }
                left = Math.max(inlineMin - leeway, Math.min(left, inlineMax + leeway));
                top = Math.max(blockMin - leeway, Math.min(top, blockMax + leeway));
               
                //æ§åˆ¶å›¾ç‰‡ç§»åŠ¨
                $("#innerdiv").css({
                  top: top + "px",
                  left: left + "px",
                });
              } else {
                // åŒæŒ‡ç§»åŠ¨
                if (events2) {
                  // ç¬¬2ä¸ªæŒ‡å¤´åæ ‡åœ¨touchmoveæ—¶å€™è·å–
                  if (!store.pageX2) {
                    store.pageX2 = events2.pageX;
                  }
                  if (!store.pageY2) {
                    store.pageY2 = events2.pageY;
                  }

                  // è·å–åæ ‡ä¹‹é—´çš„è·ç¦»
                  var getDistance = function (start, stop) {
                    //ç”¨åˆ°ä¸‰è§’å‡½æ•°
                    return Math.hypot(stop.x - start.x, stop.y - start.y);
                  };
                  // åŒæŒ‡ç¼©æ”¾æ¯”ä¾‹è®¡ç®—
                  var zoom =
                    getDistance(
                      {
                        x: events.pageX,
                        y: events.pageY,
                      },
                      {
                        x: events2.pageX,
                        y: events2.pageY,
                      }
                    ) /
                    getDistance(
                      {
                        x: store.pageX,
                        y: store.pageY,
                      },
                      {
                        x: store.pageX2,
                        y: store.pageY2,
                      }
                    );
                  // åº”ç”¨åœ¨å…ƒç´ ä¸Šçš„ç¼©æ”¾æ¯”ä¾‹
                  var newScale = store.originScale * zoom * 0.8;
                  var maxScale = 3, minScale = 1;
                  // æœ€å¤§ç¼©æ”¾æ¯”ä¾‹é™åˆ¶
                  if (newScale > maxScale) {
                    newScale = maxScale;
                  }
                  if(newScale < minScale){
                    newScale = minScale;
                  }
                  // è®°ä½ä½¿ç”¨çš„ç¼©æ”¾å€¼
                  store.scale = newScale;
                  // å›¾åƒåº”ç”¨ç¼©æ”¾æ•ˆæœ
                  eleImg.style.transform = "scale(" + newScale + ")";
                }
              }
            },
            { passive: false }
          );

          document.addEventListener("touchend", function () {
            store.moveable = false;
            delete store.pageX2;
            delete store.pageY2;
          });
          document.addEventListener("touchcancel", function () {
            store.moveable = false;
            delete store.pageX2;
            delete store.pageY2;
          });
        });
        //ç§»åŠ¨ç«¯æ‰‹æŒ‡é¡µé¢ç»“æŸ
      });

      //é®ç½©å±‚å›¾ç‰‡ä½ç½®
      function imgShow(outerdiv, innerdiv, bigimg, _this) {
        //è¿™æ˜¯åˆšæ‰åˆ¤æ–­æ˜¯å¦PCç«¯çš„å‡½æ•°äº‹ä»¶
        var flag = IsPC();
        console.log(flag);
        var src = _this.attr("src"); //è·å–å½“å‰ç‚¹å‡»çš„pimgå…ƒç´ ä¸­çš„srcå±æ€§
        $(bigimg).attr("src", src); //è®¾ç½®#bigimgå…ƒç´ çš„srcå±æ€§
        /*è·å–å½“å‰ç‚¹å‡»å›¾ç‰‡çš„çœŸå®å¤§å°ï¼Œå¹¶æ˜¾ç¤ºå¼¹å‡ºå±‚åŠå¤§å›¾*/
        $("<img/>")
          .attr("src", src)
          .load(function () {
            //æ³¨æ„åœ¨ä½¿ç”¨è¿™ç§æ–¹æ³•è·å–çª—å£é«˜åº¦å’Œå®½åº¦çš„æ—¶å€™,
            //åŠ¡å¿…åœ¨htmlé¡µé¢æœ€ä¸Šæ–¹åŠ ä¸Šä¸€å¥<!DOCTYPE html>,å¦åˆ™è·å–å±å¹•é«˜åº¦æ—¶ä¼šå‡ºé—®é¢˜
            var windowW = $(window).width(); //è·å–å½“å‰çª—å£å®½åº¦
            console.log("ğŸš€ ~ file: index copy.html:262 ~ windowW:", windowW)
            var windowH = $(window).height(); //è·å–å½“å‰çª—å£é«˜åº¦
            console.log("ğŸš€ ~ file: index copy.html:264 ~ windowH:", windowH)
            var realWidth = this.width; //è·å–å›¾ç‰‡çœŸå®å®½åº¦
            var realHeight = this.height; //è·å–å›¾ç‰‡çœŸå®é«˜åº¦
            var imgWidth, imgHeight;
            var scale = 0.8; //ç¼©æ”¾å°ºå¯¸ï¼Œå½“å›¾ç‰‡çœŸå®å®½åº¦å’Œé«˜åº¦å¤§äºçª—å£å®½åº¦å’Œé«˜åº¦æ—¶è¿›è¡Œç¼©æ”¾
            if (realHeight > windowH * scale) {
              //åˆ¤æ–­å›¾ç‰‡é«˜åº¦
              imgHeight = windowH * scale; //å¦‚å¤§äºçª—å£é«˜åº¦ï¼Œå›¾ç‰‡é«˜åº¦è¿›è¡Œç¼©æ”¾
              imgWidth = (imgHeight / realHeight) * realWidth; //ç­‰æ¯”ä¾‹ç¼©æ”¾å®½åº¦
              if (imgWidth > windowW * scale) {
                //å¦‚å®½åº¦æ‰”å¤§äºçª—å£å®½åº¦
                imgWidth = windowW * scale; //å†å¯¹å®½åº¦è¿›è¡Œç¼©æ”¾
              }
            } else if (realWidth > windowW * scale) {
              //å¦‚å›¾ç‰‡é«˜åº¦åˆé€‚ï¼Œåˆ¤æ–­å›¾ç‰‡å®½åº¦
              imgWidth = windowW * scale; //å¦‚å¤§äºçª—å£å®½åº¦ï¼Œå›¾ç‰‡å®½åº¦è¿›è¡Œç¼©æ”¾
              imgHeight = (imgWidth / realWidth) * realHeight; //ç­‰æ¯”ä¾‹ç¼©æ”¾é«˜åº¦
            } else {
              //å¦‚æœå›¾ç‰‡çœŸå®é«˜åº¦å’Œå®½åº¦éƒ½ç¬¦åˆè¦æ±‚ï¼Œé«˜å®½ä¸å˜
              if (flag == false) {
                imgWidth = realWidth;
                imgHeight = realHeight;
              } else if (realWidth >= 1000) {
                //è¿™é‡Œæˆ‘æ€•å›¾ç‰‡å¤ªå¤§åˆåšäº†ä¸ªåˆ¤æ–­
                imgWidth = realWidth;
                imgHeight = realHeight;
              } else {
                imgWidth = realWidth * 2;
                imgHeight = realHeight * 2;
              }
            }
            $(bigimg).css("width", imgWidth); //ä»¥æœ€ç»ˆçš„å®½åº¦å¯¹å›¾ç‰‡ç¼©æ”¾
            var w = (windowW - imgWidth) / 2; //è®¡ç®—å›¾ç‰‡ä¸çª—å£å·¦è¾¹è·
            var h = (windowH - imgHeight) / 2; //è®¡ç®—å›¾ç‰‡ä¸çª—å£ä¸Šè¾¹è·
            $(innerdiv).css({
              top: h,
              left: w,
            }); //è®¾ç½®#innerdivçš„topå’Œleftå±æ€§
            $(outerdiv).fadeIn("fast"); //æ·¡å…¥æ˜¾ç¤º#outerdivåŠ.pimg
          });
        $(outerdiv).click(function () {
          //å†æ¬¡ç‚¹å‡»æ·¡å‡ºæ¶ˆå¤±å¼¹å‡ºå±‚
          $(this).fadeOut("fast");
        });
      }

      function IsPC(){  
        var userAgentInfo = navigator.userAgent;
        var Agents = new Array("Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod");  
        var flag = true;  
        for (var v = 0; v < Agents.length; v++) {  
            if (userAgentInfo.indexOf(Agents[v]) > 0) { flag = false; break; }  
        }  
        return flag;  
      }
    </script>
  </body>
</html>
